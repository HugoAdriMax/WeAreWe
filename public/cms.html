<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS - Gestion des Articles</title>
    <!-- Tailwind CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/public/output.css">
    <!-- TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/yvlqpv5o38e5lbw0ao8rtwqkzr6bcptnwsjonwqs5w86c5wp/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Favicon -->
    <link rel="icon" href="https://i.imgur.com/PL6qLai.png" type="image/png">
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex items-center justify-center">
        <!-- Login Form -->
        <div id="login-form" class="bg-white shadow-lg rounded-lg p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Connexion</h1>
                <p class="text-gray-500">Accédez à votre compte</p>
            </div>
            <form id="login">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 font-medium">ID</label>
                    <input type="text" id="username" class="mt-1 w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 font-medium">Mot de passe</label>
                    <input type="password" id="password" class="mt-1 w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition duration-200">Se connecter</button>
            </form>
        </div>

        <!-- CMS -->
        <div id="cms" class="hidden w-full max-w-6xl mx-auto px-4 py-12">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Créer un nouvel article</h2>
                <form id="article-form" class="bg-white shadow-lg rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="title" class="block text-gray-700 font-medium">Titre</label>
                            <input type="text" id="title" class="mt-1 w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="url" class="block text-gray-700 font-medium">URL de l'article (SEO-friendly)</label>
                            <input type="text" id="url" class="mt-1 w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="metaDescription" class="block text-gray-700 font-medium">Meta Description</label>
                            <input type="text" id="metaDescription" class="mt-1 w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="imageUrl" class="block text-gray-700 font-medium">URL de l'image</label>
                            <input type="text" id="imageUrl" class="mt-1 w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label class="block text-gray-700 font-medium mb-2">Contenu</label>
                        <textarea id="editor"></textarea>
                    </div>
                    <div class="mt-6 text-right">
                        <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition duration-200">Créer l'article</button>
                    </div>
                </form>
            </div>

            <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Articles existants</h2>
                <ul id="article-list" class="space-y-4">
                    <!-- Articles will be loaded here -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // TinyMCE initialization
        tinymce.init({
            selector: '#editor',
            height: 400,
            plugins: 'link image code',
            toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | code',
        });

        // Auth logic
        document.getElementById('login').addEventListener('submit', function (e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === 'password') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('cms').style.display = 'block';
                loadArticles();
            } else {
                alert('ID ou Mot de passe incorrect');
            }
        });

        // Load articles
        function loadArticles() {
            fetch('https://www.tolly.fr/api/articles')
                .then(response => {
                    if (!response.ok) throw new Error('Erreur lors de la récupération des articles');
                    return response.json();
                })
                .then(data => {
                    const articleList = document.getElementById('article-list');
                    articleList.innerHTML = '';

                    data.forEach(article => {
    const li = document.createElement('li');
    li.innerHTML = `
        <h3 class="text-xl">${article.title}</h3>
        <button onclick="editArticle('${article._id}')" class="bg-yellow-500 text-white px-4 py-2 rounded-lg mr-2">Modifier</button>
        <button onclick="deleteArticle('${article._id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg">Supprimer</button>`;
    articleList.appendChild(li);
});

                })
                .catch(error => console.error(error));
        }

        // Function to sanitize the URL for SEO-friendly format
        function createSEOUrl(title) {
            return title.trim().toLowerCase()
                .replace(/[àáâäæãåā]/g, 'a')
                .replace(/[çćč]/g, 'c')
                .replace(/[èéêëēėę]/g, 'e')
                .replace(/[îïíīįì]/g, 'i')
                .replace(/[ôöòóœøōõ]/g, 'o')
                .replace(/[ùûüūú]/g, 'u')
                .replace(/[ÿ]/g, 'y')
                .replace(/[ñ]/g, 'n')
                .replace(/[ß]/g, 'ss')
                .replace(/[^a-z0-9]/g, '-') // Replace spaces and special characters by '-'
                .replace(/-+/g, '-') // Replace multiple '-' by single '-'
                .replace(/^-|-$/g, ''); // Remove leading/trailing '-'
        }

        // Create new article
        document.getElementById('article-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const url = createSEOUrl(title); // Génère l'URL SEO-friendly
            const metaDescription = document.getElementById('metaDescription').value;
            const imageUrl = document.getElementById('imageUrl').value;
            const content = tinymce.get('editor').getContent();

            if (!title || !metaDescription || !imageUrl || !content) {
                alert('Tous les champs doivent être remplis.');
                return;
            }

            fetch('https://www.tolly.fr/api/articles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, url, metaDescription, imageUrl, content })
            })
            .then(response => {
                if (!response.ok) throw new Error('Erreur lors de la création de l\'article');
                return response.json();
            })
            .then(() => {
                alert('Article créé avec succès');
                loadArticles();
            })
            .catch(error => {
                console.error(error);
                alert('Erreur lors de la création de l\'article.');
            });
        });

// Edit article
function editArticle(id) {
    fetch(`https://www.tolly.fr/api/articles/${id}`)
        .then(response => {
            if (!response.ok) throw new Error('Erreur lors de la récupération de l\'article');
            return response.json();
        })
        .then(article => {
            document.getElementById('title').value = article.title;
            document.getElementById('url').value = article.slug; // Utiliser slug au lieu de l'URL
            document.getElementById('metaDescription').value = article.metaDescription;
            document.getElementById('imageUrl').value = article.imageUrl;
            tinymce.get('editor').setContent(article.content);
        })
        .catch(error => console.error(error));
}

// Fonction pour supprimer un article
function deleteArticle(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet article ?')) {
        fetch(`https://www.tolly.fr/api/articles/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Article supprimé avec succès');
                loadArticles(); // Recharger la liste des articles après suppression
            } else {
                alert('Erreur lors de la suppression de l\'article');
            }
        })
        .catch(error => {
            console.error('Erreur lors de la suppression de l\'article :', error);
        });
    }
}



    </script>
</body>
</html>